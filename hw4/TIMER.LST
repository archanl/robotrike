8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    07:16:45  11/18/;3  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\UTIL\ASM86.EXE TIMER.ASM M1 EP DB


LOC  OBJ                  LINE     SOURCE

                             1         NAME    TIMER
                             2     
                             3     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             4     ;                                                                            ;
                             5     ;                                    TIMER                                   ;
                             6     ;                      Timer and Interrupt Setup Functions                   ;
                             7     ;                                   EE/CS 51                                 ;
                             8     ;                                 Archan Luhar                               ;
                             9     ;                                 TA: Joe Greef                              ;
                            10     ;                                                                            ;
                            11     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                            12     
                            13     ; This file contains functions to initialize the timers and their event
                            14     ; handlers.
                            15     ;
                            16     ; The included public functions are:
                            17     ;   - SetDisplayTimerEventHandler/InstallTimer2EventHandler
                            18     ;           Installs the event handler for timer 2 into the vector table.
                            19     ;   - SetDisplayTimerInterrupt/InitTimer
                            20     ;           Initializes the timers and their interrupts
                            21     ; The included private functions are:
                            22     ;   - Timer2EventHandler
                            23     ;           Calls all necessary external event handlers that rely on timer 2
                            24     ;
                            25     ;
                            26     ; Revision History:
                            27     ;       11/12/2013      Archan Luhar    Adopted Glen George's timer code
                            28     ;                                       for the display assignment.
                            29     ;       11/18/2013      Archan Luhar    Cleaned up formatting and commenting.
                            30     
                            31     ; Local include files
                            32 +1  $INCLUDE(timer.inc)     ; Contains various addresses and values related to
                      =1    33     ; Timer Interrupt Vector
  0013                =1    34     Tmr2Vec         EQU     19              ; Timer 2
                      =1    35     
                      =1    36     
                      =1    37     ; Interrupt Controller Addresses
  FF32                =1    38     INTCtrlrCtrl    EQU     0FF32H          ; Timer interrupt controller
  FF22                =1    39     INTCtrlrEOI     EQU     0FF22H          ; Interrupt controller EOI register
                      =1    40     
                      =1    41     ; Interrupt Controller Register Values
  0001                =1    42     INTCtrlrCVal    EQU     00001H          ;0000 0000 0000 ----  reserved
                      =1    43                                             ;---- ---- ---- 0---  enable interrupt
                      =1    44                                             ;---- ---- ---- -001  timer priority
                      =1    45     
  0008                =1    46     TimerEOI        EQU     00008H          ; Timer EOI command for all timers
                      =1    47     
                      =1    48     
                      =1    49     ; Timer Addresses
  FF66                =1    50     Tmr2Ctrl        EQU     0FF66H          ; Timer 2 Control Register
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    07:16:45  11/18/;3  PAGE    2


LOC  OBJ                  LINE     SOURCE

  FF62                =1    51     Tmr2MaxCnt      EQU     0FF62H          ; Timer 2 Max Count A Register
  FF60                =1    52     Tmr2Count       EQU     0FF60H          ; Timer 2 Count Register
                      =1    53     
                      =1    54     ; Timer Control Register Value
  E001                =1    55     Tmr2CtrlVal     EQU     0E001H          ;1--- ---- ---- ----  enable timer
                      =1    56                                             ;-1-- ---- ---- ----  write to control
                      =1    57                                             ;--1- ---- ---- ----  enable interrupts
                      =1    58                                             ;---- 0000 00-0 000-  reserved
                      =1    59                                             ;---0 ---- --0- ----  read only
                      =1    60                                             ;---- ---- ---- ---1  continuous mode
                      =1    61     
                      =1    62     
                      =1    63     ; Timing Definitions
  0900                =1    64     COUNTS_PER_MS   EQU     2304            ; Number of timer counts per 1 ms
                      =1    65                                             ; (assumes 18.432 MHz clock)
                            66                             ; interrupt and timer behavior
                            67     
                            68     
                            69     CGROUP  GROUP   CODE
----                        70     CODE    SEGMENT PUBLIC 'CODE'
                            71             ASSUME  CS:CGROUP
                            72     
                            73     ; External references
                            74     ; All non-meta timer event handlers should be listed here
                            75         EXTRN   DisplayTimerEventHandler:NEAR
                            76     
                            77     
                            78     ; SetDisplayTimerEventHandler/InstallTimer2EventHandler
                            79     ;
                            80     ; Description:      Installs the timer 2 interrupt event handler into the
                            81     ;                   interrupt vector table.
                            82     ;
                            83     ; Operation:        Writes the segment and and offset of the handler to the
                            84     ;                   appropriate slot in the interrupt vector table.
                            85     ;
                            86     ; Arguments:        None.
                            87     ; Return Value:     None.
                            88     ;
                            89     ; Local Variables:  None.
                            90     ; Shared Variables: None.
                            91     ; Global Variables: None.
                            92     ;
                            93     ; Input:            None.
                            94     ; Output:           None.
                            95     ;
                            96     ; Error Handling:   None.
                            97     ;
                            98     ; Algorithms:       None.
                            99     ; Data Structures:  None.
                           100     ;
                           101     ; Registers Used:   None.
                           102     ; Stack Depth:      2 words.
                           103     ;
                           104     ; Author:           Glen George, Archan Luhar
                           105     ; Last Modified:    Nov. 18, 2013
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    07:16:45  11/18/;3  PAGE    3


LOC  OBJ                  LINE     SOURCE

                           106     
0000                       107     SetDisplayTimerEventHandler PROC    NEAR
                           108                                 PUBLIC  SetDisplayTimerEventHandler
0000                       109     InstallTimer2EventHandler   PROC    NEAR
                           110                                 PUBLIC  InstallTimer2EventHandler
                           111     
0000 50                    112         PUSH AX                     ; Save Registers
0001 06                    113         PUSH ES
                           114     
0002 33C0                  115         XOR     AX, AX              ; Clear ES (interrupt vectors are in segment 0)
0004 8EC0                  116         MOV     ES, AX
                           117                                     ; Write the vector
0006 26C7064C001700 R      118         MOV     ES: WORD PTR (4 * Tmr2Vec), OFFSET(Timer2EventHandler)
000D 26C7064E00---- R      119         MOV     ES: WORD PTR (4 * Tmr2Vec + 2), SEG(Timer2EventHandler)
                           120     
0014 07                    121         POP ES
0015 58                    122         POP AX
0016 C3                    123         RET
                           124     
                           125     InstallTimer2EventHandler   ENDP
                           126     SetDisplayTimerEventHandler ENDP
                           127     
                           128     
                           129     ; Timer2EventHandler
                           130     ;
                           131     ; Description:      Handles the timer 2 interrupts. Calls the display handler.
                           132     ;
                           133     ; Operation:        Saves necessary registers.
                           134     ;                   Calls the display timer event handler.
                           135     ;                   Sends a timer EOI to the interrupt control register.
                           136     ;                   Then returns using IRET.
                           137     ;
                           138     ; Arguments:        None.
                           139     ; Return Value:     None.
                           140     ;
                           141     ; Local Variables:  None.
                           142     ; Shared Variables: None.
                           143     ; Global Variables: None.
                           144     ;
                           145     ; Input:            None.
                           146     ; Output:           None.
                           147     ;
                           148     ; Error Handling:   None.
                           149     ;
                           150     ; Algorithms:       None.
                           151     ; Data Structures:  None.
                           152     ;
                           153     ; Registers Used:   None.
                           154     ; Stack Depth:      0 words
                           155     ;
                           156     ; Author:           Glen George, Archan Luhar
                           157     ; Last Modified:    Nov. 18, 2013
                           158     
0017                       159     Timer2EventHandler          PROC    NEAR
                           160     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    07:16:45  11/18/;3  PAGE    4


LOC  OBJ                  LINE     SOURCE

0017 52                    161         PUSH DX
0018 50                    162         PUSH AX
                           163     
0019 E80000         E      164         CALL DisplayTimerEventHandler
                           165     
001C BA22FF                166         MOV DX, INTCtrlrEOI             ; Send timer EOI
001F B80800                167         MOV AX, TimerEOI
0022 EE                    168         OUT DX, AL
                           169     
0023 58                    170         POP AX
0024 5A                    171         POP DX
0025 CF                    172         IRET                            ; IRET must be used in interrupt handler
                           173     
                           174     Timer2EventHandler          ENDP
                           175     
                           176     
                           177     ; SetDisplayTimerInterrupt/InitTimer
                           178     ;
                           179     ; IMPORTANT NOTE:   CURRENLTY ONLY INITIALIZES TIMER 2.
                           180     ;
                           181     ; Description:      Initialize the 80188 Timers.  The timers are initialized
                           182     ;                   to generate interrupts every MS_PER_SEC milliseconds.
                           183     ;                   The interrupt controller is also initialized to allow the
                           184     ;                   timer interrupts.  Timer #2 is used to generate the
                           185     ;                   interrupts for the display handler.
                           186     ;
                           187     ; Operation:        The appropriate values are written to the timer control
                           188     ;                   registers in the PCB.  Also, the timer count registers
                           189     ;                   are reset to zero.  Finally, the interrupt controller is
                           190     ;                   setup to accept timer interrupts and any pending
                           191     ;                   interrupts are cleared by sending a TimerEOI to the
                           192     ;                   interrupt controller.
                           193     ;
                           194     ; Arguments:        None.
                           195     ; Return Value:     None.
                           196     ;
                           197     ; Local Variables:  None.
                           198     ; Shared Variables: None.
                           199     ; Global Variables: None.
                           200     ;
                           201     ; Input:            None.
                           202     ; Output:           None.
                           203     ;
                           204     ; Error Handling:   None.
                           205     ;
                           206     ; Algorithms:       None.
                           207     ; Data Structures:  None.
                           208     ;
                           209     ; Registers Used:   None.
                           210     ; Stack Depth:      0 words
                           211     ;
                           212     ; Author:           Glen George, Archan Luhar
                           213     ; Last Modified:    Nov. 18, 2013
                           214     
0026                       215     SetDisplayTimerInterrupt    PROC    NEAR
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    07:16:45  11/18/;3  PAGE    5


LOC  OBJ                  LINE     SOURCE

                           216                                 PUBLIC  SetDisplayTimerInterrupt
0026                       217     InitTimer                   PROC    NEAR
                           218                                 PUBLIC  InitTimer
                           219     
0026 50                    220             PUSH AX                     ; Save registers
0027 52                    221             PUSH DX
                           222     
0028 BA60FF                223             MOV     DX, Tmr2Count       ; Initialize the count register to 0
002B 33C0                  224             XOR     AX, AX
002D EE                    225             OUT     DX, AL
                           226     
002E BA62FF                227             MOV     DX, Tmr2MaxCnt      ; Setup max count for 1ms counts
0031 B80009                228             MOV     AX, COUNTS_PER_MS
0034 EE                    229             OUT     DX, AL
                           230     
0035 BA66FF                231             MOV     DX, Tmr2Ctrl        ; Setup control register, enable interrupts
0038 B801E0                232             MOV     AX, Tmr2CtrlVal
003B EE                    233             OUT     DX, AL
                           234                                         ; Initialize interrupt controller for timers
003C BA32FF                235             MOV     DX, INTCtrlrCtrl    ; Setup the interrupt control register
003F B80100                236             MOV     AX, INTCtrlrCVal
0042 EE                    237             OUT     DX, AL
                           238     
0043 BA22FF                239             MOV     DX, INTCtrlrEOI     ; Send a timer EOI (to clear out controller)
0046 B80800                240             MOV     AX, TimerEOI
0049 EE                    241             OUT     DX, AL
                           242             
004A 5A                    243             POP DX                      ; Restore registers
004B 58                    244             POP AX
                           245     
004C C3                    246             RET
                           247     
                           248     InitTimer                   ENDP
                           249     SetDisplayTimerInterrupt    ENDP
                           250     
                           251     
----                       252     CODE ENDS
                           253         END

ASSEMBLY COMPLETE, NO ERRORS FOUND
